<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bản đồ Tòa nhà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/photo-sphere-viewer.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom styles for markers */
        .marker {
            position: absolute;
            width: 30px; /* Kích thước điểm đánh dấu */
            height: 30px;
            background-color: #ef4444; /* Màu đỏ */
            border-radius: 50%; /* Hình tròn */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
            transform: translate(-50%, -50%); /* Căn giữa điểm đánh dấu trên tọa độ */
            z-index: 10;
        }
        .marker:hover {
            transform: translate(-50%, -50%) scale(1.1);
            background-color: #dc2626;
        }
        /* Style for the 360 viewer container */
        #photosphere {
            width: 100%;
            height: 100%;
            border-radius: 0.5rem; /* Match modal's rounded corners */
            overflow: hidden; /* Ensure content stays within rounded corners */
        }
        /* Ensure the modal content scrolls if it's too long */
        #modalContent {
            max-height: 70vh; /* Giới hạn chiều cao để nội dung có thể cuộn */
            overflow-y: auto; /* Cho phép cuộn dọc */
        }
    </style>
</head>
<body class="p-4">

    <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8">Bản đồ Tòa nhà & Xem Phòng 360°</h1>

    <div class="relative w-full max-w-5xl mx-auto bg-white rounded-xl shadow-2xl overflow-hidden">
        <img id="mapImage" src="ht.png" alt="Bản đồ tòa nhà" class="w-full h-auto rounded-xl">
        <div id="markersContainer" class="absolute top-0 left-0 w-full h-full">
            </div>
    </div>

    <div id="detailsModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-auto transform transition-all duration-300 scale-95 opacity-0" id="detailsModalContent">
            <h2 id="modalTitle" class="text-3xl font-bold text-gray-800 mb-6 text-center"></h2>
            <div id="modalContent" class="space-y-4 text-lg">
                </div>
            <button id="closeModal" class="mt-8 w-full px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 ease-in-out shadow-md">
                Đóng
            </button>
        </div>
    </div>

    <div id="viewerModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div class="relative bg-gray-900 rounded-xl shadow-2xl w-full max-w-4xl h-3/4 transform transition-all duration-300 scale-95 opacity-0" id="viewerModalContent">
            <div id="photosphere" class="w-full h-full"></div>
            <button id="closeViewer" class="absolute top-4 right-4 px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 ease-in-out shadow-md z-10">
                Đóng
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eventemitter3@4.0.7/umd/eventemitter3.min.js"></script>
    <script>
        // Ensure EventEmitter is globally available for PhotoSphereViewer v4
        // The UMD bundle of eventemitter3 typically attaches to window.EventEmitter3.
        // PhotoSphereViewer v4 expects it to be available as window.EventEmitter.
        if (typeof EventEmitter3 !== 'undefined' && typeof window.EventEmitter === 'undefined') {
            window.EventEmitter = EventEmitter3;
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/photo-sphere-viewer.min.js"></script>

    <script>
        // Dữ liệu giả định cho các tòa nhà, tầng và phòng
        // Bạn sẽ cần cập nhật tọa độ (x, y) của marker để phù hợp với bản đồ 'ht.png' của bạn.
        // Tọa độ (x, y) là phần trăm từ góc trên bên trái của ảnh bản đồ.
        const buildingsData = [
            {
                id: 'building1',
                name: 'Tòa nhà A',
                marker: { x: 30, y: 40 }, // Tọa độ ví dụ (30% từ trái, 40% từ trên)
                floors: [
                    {
                        id: 'floor1_A',
                        name: 'Tầng 1',
                        rooms: [
                            { id: 'room101_A', name: 'Phòng 101', image: 'https://placehold.co/1000x500/000/FFF?text=Phong+101' },
                            { id: 'room102_A', name: 'Phòng 102', image: 'Hs.jpg' }, // Sử dụng 'Hs.jpg' như yêu cầu
                            { id: 'room103_A', name: 'Phòng 103', image: 'https://placehold.co/1000x500/000/FFF?text=Phong+103' }
                        ]
                    },
                    {
                        id: 'floor2_A',
                        name: 'Tầng 2',
                        rooms: [
                            { id: 'room201_A', name: 'Phòng 201', image: 'https://placehold.co/1000x500/000/FFF?text=Phong+201' },
                            { id: 'room202_A', name: 'Phòng 202', image: 'https://placehold.co/1000x500/000/FFF?text=Phong+202' }
                        ]
                    }
                ]
            },
            {
                id: 'building2',
                name: 'Tòa nhà B',
                marker: { x: 70, y: 25 }, // Tọa độ ví dụ khác
                floors: [
                    {
                        id: 'floor1_B',
                        name: 'Tầng Trệt',
                        rooms: [
                            { id: 'roomB01', name: 'Phòng B01', image: 'https://placehold.co/1000x500/000/FFF?text=Phong+B01' }
                        ]
                    },
                    {
                        id: 'floor2_B',
                        name: 'Tầng 1',
                        rooms: [
                            { id: 'roomB11', name: 'Phòng B11', image: 'https://placehold.co/1000x500/000/FFF?text=Phong+B11' },
                            { id: 'roomB12', name: 'Phòng B12', image: 'https://placehold.co/1000x500/000/FFF?text=Phong+B12' }
                        ]
                    }
                ]
            }
            // Thêm các tòa nhà khác tại đây
        ];

        // Lấy các phần tử DOM
        const mapImage = document.getElementById('mapImage');
        const markersContainer = document.getElementById('markersContainer');
        const detailsModal = document.getElementById('detailsModal');
        const detailsModalContent = document.getElementById('detailsModalContent');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModal');
        const viewerModal = document.getElementById('viewerModal');
        const viewerModalContent = document.getElementById('viewerModalContent');
        const closeViewerBtn = document.getElementById('closeViewer');
        const photosphereContainer = document.getElementById('photosphere');

        let currentViewer = null; // Biến để lưu trữ thể hiện PhotoSphereViewer

        // Hàm hiển thị modal
        function showModal(modalElement, contentElement) {
            modalElement.classList.remove('hidden');
            // Kích hoạt hiệu ứng chuyển đổi
            setTimeout(() => {
                contentElement.classList.remove('scale-95', 'opacity-0');
                contentElement.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // Hàm ẩn modal
        function hideModal(modalElement, contentElement) {
            // Kích hoạt hiệu ứng chuyển đổi ngược
            contentElement.classList.remove('scale-100', 'opacity-100');
            contentElement.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300); // Thời gian khớp với thời gian chuyển đổi CSS
        }

        // Hàm tạo và hiển thị các điểm đánh dấu trên bản đồ
        function createMarkers() {
            // Đảm bảo container trống trước khi thêm marker mới
            markersContainer.innerHTML = '';
            buildingsData.forEach(building => {
                const marker = document.createElement('div');
                marker.classList.add('marker');
                marker.textContent = building.name.charAt(0); // Hiển thị chữ cái đầu tiên của tên tòa nhà
                // Tính toán vị trí dựa trên phần trăm của ảnh
                marker.style.left = `${building.marker.x}%`;
                marker.style.top = `${building.marker.y}%`;

                marker.addEventListener('click', () => {
                    displayFloors(building);
                });
                markersContainer.appendChild(marker);
            });
        }

        // Hàm hiển thị danh sách các tầng của một tòa nhà
        function displayFloors(building) {
            modalTitle.textContent = `Tòa nhà: ${building.name}`;
            modalContent.innerHTML = ''; // Xóa nội dung cũ

            building.floors.forEach(floor => {
                const floorItem = document.createElement('button');
                floorItem.classList.add('w-full', 'p-4', 'bg-blue-500', 'text-white', 'rounded-lg', 'shadow-md', 'hover:bg-blue-600', 'transition', 'duration-200', 'ease-in-out', 'font-medium');
                floorItem.textContent = floor.name;
                floorItem.addEventListener('click', () => {
                    displayRooms(floor);
                });
                modalContent.appendChild(floorItem);
            });
            showModal(detailsModal, detailsModalContent);
        }

        // Hàm hiển thị danh sách các phòng của một tầng
        function displayRooms(floor) {
            modalTitle.textContent = `Tầng: ${floor.name}`;
            modalContent.innerHTML = ''; // Xóa nội dung cũ

            floor.rooms.forEach(room => {
                const roomItem = document.createElement('button');
                roomItem.classList.add('w-full', 'p-4', 'bg-green-500', 'text-white', 'rounded-lg', 'shadow-md', 'hover:bg-green-600', 'transition', 'duration-200', 'ease-in-out', 'font-medium');
                roomItem.textContent = room.name;
                roomItem.addEventListener('click', () => {
                    open360Viewer(room.image);
                });
                modalContent.appendChild(roomItem);
            });
        }

        // Hàm mở trình xem ảnh 360 độ
        function open360Viewer(imagePath) {
            hideModal(detailsModal, detailsModalContent); // Ẩn modal chi tiết trước

            // Giải phóng trình xem cũ nếu có
            if (currentViewer) {
                currentViewer.destroy();
                currentViewer = null;
            }

            // Khởi tạo PhotoSphereViewer
            currentViewer = new PhotoSphereViewer.Viewer({
                container: photosphereContainer,
                panorama: imagePath,
                caption: 'Ảnh 360 độ',
                loadingImg: 'https://cdn.jsdelivr.net/npm/photo-sphere-viewer@4/dist/loader.gif', // Hình ảnh tải
                navbar: [
                    'zoom',
                    'move',
                    'fullscreen',
                    'caption',
                    'autorotate',
                ],
                plugins: [
                    PhotoSphereViewer.AutorotatePlugin,
                ],
            });

            showModal(viewerModal, viewerModalContent);
        }

        // Đóng modal chi tiết
        closeModalBtn.addEventListener('click', () => {
            hideModal(detailsModal, detailsModalContent);
        });

        // Đóng modal xem 360 độ
        closeViewerBtn.addEventListener('click', () => {
            hideModal(viewerModal, viewerModalContent);
            if (currentViewer) {
                currentViewer.destroy(); // Hủy trình xem khi đóng modal
                currentViewer = null;
            }
        });

        // Khởi tạo các điểm đánh dấu khi ảnh bản đồ được tải
        mapImage.onload = createMarkers;
        // Nếu ảnh đã được tải (ví dụ: từ bộ nhớ cache), gọi ngay lập tức
        if (mapImage.complete) {
            createMarkers();
        }

        // Đóng modal khi nhấp ra bên ngoài (cho cả hai modal)
        detailsModal.addEventListener('click', (event) => {
            if (event.target === detailsModal) {
                hideModal(detailsModal, detailsModalContent);
            }
        });

        viewerModal.addEventListener('click', (event) => {
            if (event.target === viewerModal) {
                hideModal(viewerModal, viewerModalContent);
                if (currentViewer) {
                    currentViewer.destroy();
                    currentViewer = null;
                }
            }
        });

    </script>
</body>
</html>
