
 <!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lê Quý Đôn Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#1a73e8', // Blue
                        secondary: '#ffffff', // White
                        light: {
                            bg: '#f0f2ff', // Lighter background for a softer feel
                            text: '#2c3e50', // Darker text for better contrast
                            sidebar: '#ffffff', // White sidebar
                            hover: '#e0e6ff' // Lighter blue hover for sidebar items
                        }
                    },
                    fontFamily: {
                        sans: ['Calibri', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Calibri', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif';
            background-color: #f0f2ff;
            color: #2c3e50;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        
        .code-block {
            position: relative;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #e9ecef;
        }
        
        .code-header {
            font-family: monospace;
            user-select: none;
        }
        
        .copy-code-btn {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .copy-code-btn:hover {
            color: #1a73e8;
        }
        
        pre {
            margin: 0 !important;
            padding: 1rem !important;
            background-color: #e9ecef !important;
            border-radius: 0 0 0.75rem 0.75rem;
            color: #2c3e50;
        }
        
        .markdown p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }
        
        .markdown ul, .markdown ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }
        
        .markdown li {
            margin-bottom: 0.5rem;
        }
        
        .markdown code:not(pre code) {
            background-color: #dfe3e7;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #2c3e50;
        }
        
        .markdown strong {
            font-weight: 700;
        }
        
        .markdown em {
            font-style: italic;
        }
        
        .markdown h1, .markdown h2, .markdown h3, .markdown h4 {
            font-weight: 700;
            margin-top: 1.8rem;
            margin-bottom: 1rem;
        }
        
        .markdown h1 {
            font-size: 1.75rem;
            line-height: 2.25rem;
        }
        
        .markdown h2 {
            font-size: 1.5rem;
            line-height: 2rem;
        }
        
        .markdown h3 {
            font-size: 1.25rem;
            line-height: 1.85rem;
        }
        
        .markdown h4 {
            font-size: 1.125rem;
            line-height: 1.65rem;
        }
        
        .markdown table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        .markdown th, .markdown td {
            padding: 0.75rem 1rem;
            border: 1px solid #d0d0d0;
            text-align: left;
        }
        
        .markdown th {
            background-color: #e9ecef;
            font-weight: 700;
        }
        
        .markdown blockquote {
            border-left: 5px solid #1a73e8;
            padding-left: 1.2rem;
            margin: 1.5rem 0;
            color: #555555;
            border-radius: 0.75rem;
            background-color: rgba(26, 115, 232, 0.08);
        }
        
        .user-message {
            align-self: flex-end;
            background-color: #1a73e8;
            color: #ffffff;
            border-radius: 1.25rem 1.25rem 0.5rem 1.25rem;
            max-width: 80%;
            margin-left: auto;
            padding: 0.85rem 1.1rem;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: #ffffff;
            color: #2c3e50;
            border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
            max-width: 80%;
            margin-right: auto;
            padding: 0.85rem 1.1rem;
            border: 1px solid #e0e0e0;
        }
        
        .typing-indicator {
            align-self: flex-start;
            background-color: #ffffff;
            color: #2c3e50;
            border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
            max-width: 80%;
            margin-right: auto;
            padding: 0.85rem 1.1rem;
            border: 1px solid #e0e0e0;
        }
        
        .message-content {
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .message-wrapper.user {
            justify-content: flex-end;
        }

        .message-wrapper.bot {
            justify-content: flex-start;
        }

        .avatar {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .avatar.user {
            background-color: #1a73e8;
            color: #ffffff;
        }

        .avatar.bot {
            background-color: #dee2e6;
            color: #495057;
        }

        .message-timestamp {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .user .message-timestamp {
            text-align: right;
            color: rgba(255, 255, 255, 0.8);
        }

        .bot .message-timestamp {
            text-align: left;
        }

        .chat-item.bg-light-hover {
            background-color: #e0e6ff;
            color: #1a73e8;
        }
        .chat-item.bg-light-hover .chat-title {
            color: #1a73e8;
        }
        .chat-item.bg-light-hover .text-xs {
            color: #6a8cdb;
        }

        header {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }
        /* Các phong cách hiện có giữ nguyên, thêm các phần sau cho sidebar responsive */
    @media (max-width: 767px) {
        #sidebar {
            position: absolute;
            z-index: 50;
            width: 75%; /* Giảm chiều rộng trên di động */
            max-width: 240px;
            transform: translateX(-100%);
        }

        #sidebar.open {
            transform: translateX(0);
        }

        /* Đảm bảo khu vực chat chiếm toàn bộ chiều rộng khi sidebar bị ẩn */
        #app > div:last-child {
            width: 100%;
        }
    }

    @media (min-width: 768px) {
        #sidebar {
            transform: none !important; /* Ngăn chặn transform trên màn hình lớn */
        }
    }

    /* Thêm lớp nền khi sidebar mở trên di động */
    #sidebar-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 40;
    }

    #sidebar-backdrop.visible {
        display: block;
    }
/* Thêm vào phần <style> hiện có */
#chat-container {
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* Đẩy nội dung xuống dưới */
    min-height: 0; /* Ngăn container chiếm quá nhiều không gian */
}

#chat-messages {
    flex-grow: 1; /* Chiếm không gian còn lại */
}

#typing-indicator, #stop-button-container {
    margin-top: 0; /* Loại bỏ khoảng cách trên */
    margin-bottom: 0.5rem; /* Giảm khoảng cách dưới */
    padding: 0.5rem; /* Giảm padding để sát hơn */
}

#chat-form {
    margin-top: 0; /* Đảm bảo ô nhập liệu sát với phần trên */
}
    </style>
</head>
<<body class="h-screen flex flex-col bg-light-bg text-light-text transition-all">
<div id="app" class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <div id="sidebar" class="w-60 bg-light-sidebar shadow-lg border-r border-gray-200 flex flex-col h-full md:block hidden transition-all duration-300">
        <div class="p-3">
            <button id="new-chat-btn" class="w-full h-10 flex items-center justify-center bg-primary hover:bg-primary/90 text-white rounded-md transition px-4 py-2 text-sm font-medium">
                <i class="fa-solid fa-plus mr-2"></i> Cuộc trò chuyện mới
            </button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto hide-scrollbar p-2"></div>
    </div>

    <!-- Khu vực Chat chính -->
    <div class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="p-4 border-b border-gray-200 bg-light-bg flex items-center justify-between">
            <button id="toggle-sidebar-btn" class="md:hidden text-gray-600 hover:text-primary focus:outline-none mr-3">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-xl font-semibold text-left flex-1">Chatbot Đoàn trường THPT Chuyên Lê Quý Đôn</h1>
            <a href="/suctrethanhnien/home" class="bg-primary hover:bg-primary/90 text-white rounded-md transition px-4 py-2 text-sm font-medium flex items-center">
                <i class="fa-solid fa-home mr-2"></i> Quay về trang chủ
            </a>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto hide-scrollbar p-4 bg-gray-100 flex flex-col gap-3">
            <div id="chat-messages" class="flex flex-col gap-3 mx-auto max-w-3xl w-full"></div>
            <div id="typing-indicator" class="hidden max-w-3xl mx-auto text-center">
                <span class="typing-dots text-gray-600">AI đang suy nghĩ, vui lòng đợi giây lát</span>
            </div>
            <div id="stop-button-container" class="hidden max-w-3xl mx-auto text-center">
                <button id="stop-response-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="fa-solid fa-stop mr-2"></i> Dừng phản hồi
                </button>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-light-bg">
            <div class="max-w-3xl mx-auto">
                <form id="chat-form" class="relative">
                    <textarea 
                        id="message-input" 
                        class="w-full p-4 pr-12 rounded-lg border border-gray-300 bg-white resize-none focus:outline-none focus:ring-2 focus:ring-primary text-gray-800"
                        placeholder="Gửi tin nhắn..."
                        rows="1"
                    ></textarea>
                    <button type="submit" class="absolute right-3 bottom-3 p-2 bg-primary text-white rounded-full hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Thay thế bằng API key thực tế của bạn
        const API_KEY = "AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        // URL đến file tailieu.txt trên GitHub Pages
        const KNOWLEDGE_BASE_URL = "https://hmtuan002.github.io/suctrethanhnien/tailieu.txt";
        
        // Biến lưu trữ nội dung kiến thức từ file
        let schoolKnowledge = "";

        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatHistory = document.getElementById('chat-history');
        const typingIndicator = document.getElementById('typing-indicator');
        const stopButtonContainer = document.getElementById('stop-button-container');

        let chats = [];
        let currentChatId = null;
        let isSending = false;
        let typingInterval = null;
        let isStopped = false;

        // Các từ khóa liên quan đến trường và Đoàn trường
        const schoolKeywords = [
            "Lê Quý Đôn", "chuyên Lê Quý Đôn", "THPT Chuyên Lê Quý Đôn", "Điện Biên", 
            "Đoàn trường", "Đoàn thanh niên", "Đoàn Thanh niên Cộng sản Hồ Chí Minh", 
            "Chi đoàn", "đoàn viên", "hoạt động đoàn", "quy định đoàn", "đại hội đoàn",
            "công tác đoàn", "lịch sử đoàn", "vai trò của đoàn", "ý nghĩa đoàn",
            "chức năng đoàn", "phong trào đoàn", "thanh niên", "sinh viên", "học sinh",
            "chào", "là ai", "ban chấp hành", "bí thư", "phó bí thư", "ủy viên",
            "thành viên", "cơ cấu tổ chức", "khen thưởng", "kỷ luật", "tập huấn",
            "sinh hoạt", "văn hóa", "thể thao", "học tập", "tình nguyện", "môi trường",
            "an ninh", "quốc phòng", "giáo dục", "tuyển sinh", "câu lạc bộ", "kì thi",
            "thành tích", "điều lệ đoàn", "phương hướng nhiệm vụ", "định hướng",
            "tuyên truyền", "bồi dưỡng", "phát triển đoàn viên", "lễ kết nạp",
            "chứng nhận đoàn viên", "sổ đoàn viên", "huy hiệu đoàn", "áo thanh niên", "Đoàn", "đoàn", "trường" 
        ];

        // Các từ khóa liên quan đến ôn thi vào 10
        const examKeywords = [
            "ôn thi", "vào 10", "lớp 10", "tuyển sinh", "đề thi", "mẫu đề", 
            "cấu trúc đề", "môn toán", "môn văn", "môn anh", "môn tiếng anh",
            "toán", "ngữ văn", "tiếng anh", "điểm chuẩn", "học bạ", "thi thử",
            "ôn tập", "kiến thức", "công thức", "tài liệu", "bài tập", "giải đề",
            "cấu trúc ngữ pháp", "văn mẫu", "thơ", "tác phẩm", "tác giả", "hình học",
            "đại số", "phương trình", "bất phương trình", "hàm số", "đồ thị", "hệ phương trình",
            "văn nghị luận", "văn tự sự", "văn miêu tả", "văn thuyết minh", "văn biểu cảm",
            "ngữ pháp", "từ vựng", "phát âm", "nghe hiểu", "đọc hiểu", "viết luận", "học", "thi"
        ];

        // Kiểm tra câu hỏi có liên quan đến trường hoặc ôn thi không
        function isRelevantQuestion(question) {
            const lowerQuestion = question.toLowerCase();
            return [...schoolKeywords, ...examKeywords].some(keyword => 
                lowerQuestion.includes(keyword.toLowerCase())
            );
        }

        // Tải kiến thức từ file tailieu.txt
        async function loadSchoolKnowledge() {
            try {
                const response = await fetch(KNOWLEDGE_BASE_URL);
                if (response.ok) {
                    schoolKnowledge = await response.text();
                    console.log("Đã tải xong kiến thức về trường");
                } else {
                    console.error("Không thể tải file tailieu.txt");
                }
            } catch (error) {
                console.error("Lỗi khi tải kiến thức:", error);
            }
        }

        // Tìm kiếm thông tin trong kiến thức của trường
        function searchInSchoolKnowledge(question) {
            if (!schoolKnowledge) return null;
            
            const lines = schoolKnowledge.split('\n');
            const relevantLines = lines.filter(line => 
                line.toLowerCase().includes(question.toLowerCase())
            );
            
            return relevantLines.length > 0 ? relevantLines.join('\n') : null;
        }

       function initApp() {
    loadChats();
    setupEventListeners();
    setupTextareaAutoResize();
    loadSchoolKnowledge();

    // Thêm lớp nền vào DOM
    document.body.appendChild(sidebarBackdrop);

    if (chats.length === 0) {
        createNewChat();
    } else {
        loadChat(chats[0].id);
    }
}

       function setupEventListeners() {
    chatForm.addEventListener('submit', handleSubmit);
    messageInput.addEventListener('input', () => {
        autoResizeTextarea();
    });
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (messageInput.value.trim() !== '') {
                chatForm.dispatchEvent(new Event('submit'));
            }
        }
    });
    newChatBtn.addEventListener('click', createNewChat);

    document.getElementById('stop-response-btn').addEventListener('click', () => {
        isStopped = true;
        if (typingInterval) {
            clearInterval(typingInterval);
            typingInterval = null;
        }
        stopButtonContainer.classList.add('hidden');
        typingIndicator.classList.add("hidden"); 
    });

    // Thêm sự kiện cho nút bật/tắt sidebar
    toggleSidebarBtn.addEventListener('click', toggleSidebar);
    sidebarBackdrop.addEventListener('click', closeSidebar);
}
function toggleSidebar() {
    sidebar.classList.toggle('open');
    sidebarBackdrop.classList.toggle('visible');
}

function closeSidebar() {
    sidebar.classList.remove('open');
    sidebarBackdrop.classList.remove('visible');
}
        function setupTextareaAutoResize() {
            messageInput.addEventListener('input', autoResizeTextarea);
        }

        function autoResizeTextarea() {
            messageInput.style.height = 'auto';
            const newHeight = Math.min(messageInput.scrollHeight, 150);
            messageInput.style.height = `${newHeight}px`;
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage || isSending) return;

            // Kiểm tra câu hỏi có liên quan không
            if (!isRelevantQuestion(userMessage)) {
                addMessageToUI("user", userMessage, new Date().toISOString());
                addMessageToUI("assistant", 
                    "Xin lỗi, tôi chỉ hỗ trợ các câu hỏi về:\n" +
                    "1. Ôn thi vào lớp 10 (Toán, Văn, Anh)\n" +
                    "2. Đoàn Thanh niên Cộng sản Hồ Chí Minh\n" +
                    "3. Trường THPT Chuyên Lê Quý Đôn (Điện Biên)\n\n" +
                    "Bạn có câu hỏi nào về các chủ đề này không?", 
                    new Date().toISOString());
                messageInput.value = "";
                autoResizeTextarea();
                return;
            }

            if (!currentChatId) {
                createNewChat();
                return;
            }

            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!currentChat) {
                console.error("Không tìm thấy cuộc trò chuyện hiện tại!");
                return;
            }

            isSending = true;
            addMessageToUI("user", userMessage, new Date().toISOString());

            // Xử lý các câu chào hỏi
            const greetings = ["chào", "hello", "hi", "xin chào"];
            if (greetings.some(greet => userMessage.toLowerCase().includes(greet))) {
                const greetingResponse = 
                    "Xin chào! Tôi là Chatbot Đoàn trường THPT Chuyên Lê Quý Đôn (Điện Biên).\n\n" +
                    "Tôi có thể giúp bạn:\n" +
                    "1. Ôn thi vào lớp 10 các môn Toán, Ngữ Văn, Tiếng Anh\n" +
                    "2. Tìm hiểu về Đoàn Thanh niên Cộng sản Hồ Chí Minh\n" +
                    "3. Cung cấp thông tin về trường THPT Chuyên Lê Quý Đôn\n\n" +
                    "Bạn cần hỗ trợ gì ạ?";
                
                displayTypingMessage(greetingResponse, () => {
                    if (!isStopped) {
                        currentChat.messages.push({ 
                            role: "assistant", 
                            content: greetingResponse,
                            timestamp: new Date().toISOString()
                        });
                        saveChats();
                    }
                }, new Date().toISOString());
                messageInput.value = "";
                autoResizeTextarea();
                isSending = false;
                return;
            }

            currentChat.messages.push({ 
                role: "user", 
                content: userMessage,
                timestamp: new Date().toISOString()
            });

            saveChats();
            updateChatTitle(currentChat);

            messageInput.value = "";
            autoResizeTextarea();
            typingIndicator.classList.remove("hidden");
            stopButtonContainer.classList.remove("hidden"); 
            isStopped = false;

            try {
                // Kiểm tra xem câu hỏi có thông tin trong kiến thức trường không
                const schoolInfo = searchInSchoolKnowledge(userMessage);
                if (schoolInfo) {
                    const response = 
                        `Theo thông tin từ trường THPT Chuyên Lê Quý Đôn:\n\n${schoolInfo}\n\n` +
                        `Nếu bạn cần thêm thông tin, vui lòng liên hệ trực tiếp với Đoàn trường.`;
                    
                    displayTypingMessage(response, () => {
                        if (!isStopped) {
                            currentChat.messages.push({ 
                                role: "assistant", 
                                content: response,
                                timestamp: new Date().toISOString()
                            });
                            saveChats();
                        }
                    }, new Date().toISOString());
                    isSending = false;
                    typingIndicator.classList.add("hidden");
                    stopButtonContainer.classList.add("hidden");
                    return;
                }

                // Nếu không có trong kiến thức trường, sử dụng Gemini
                const historyForGemini = currentChat.messages.map(msg => ({
                    role: msg.role === "user" ? "user" : "model",
                    parts: [{ text: msg.content }]
                }));

                // Tạo prompt phù hợp với loại câu hỏi
                let systemPrompt = "";
                if (examKeywords.some(keyword => userMessage.toLowerCase().includes(keyword.toLowerCase()))) {
                    systemPrompt = 
                        "Bạn là trợ lý ôn thi vào lớp 10, chuyên về các môn Toán, Ngữ Văn và Tiếng Anh. " +
                        "Hãy trả lời câu hỏi một cách chi tiết, chính xác và dễ hiểu. " +
                        "Nếu là câu hỏi về giải bài tập, hãy trình bày từng bước rõ ràng. " +
                        "Nếu là câu hỏi lý thuyết, hãy giải thích ngắn gọn nhưng đầy đủ.";
                } else {
                    systemPrompt = 
                        "Bạn là Chatbot Đoàn trường THPT Chuyên Lê Quý Đôn, Điện Biên. " +
                        "Hãy trả lời các câu hỏi về Đoàn Thanh niên Cộng sản Hồ Chí Minh, " +
                        "các hoạt động Đoàn và thông tin về trường một cách chính xác, nhiệt tình. " +
                        "Nếu không chắc chắn, hãy đề nghị người hỏi liên hệ trực tiếp với Đoàn trường.";
                }

                const chatSession = model.startChat({
                    history: [
                        {
                            role: "user",
                            parts: [{ text: systemPrompt }]
                        },
                        {
                            role: "model",
                            parts: [{ text: "Tôi hiểu và sẽ tuân thủ các yêu cầu trên." }]
                        },
                        ...historyForGemini
                    ],
                    generationConfig: {
                        maxOutputTokens: 2000,
                        temperature: 0.7,
                        topP: 0.9,
                        topK: 40,
                    }
                });

                const result = await chatSession.sendMessage(userMessage);
                const response = await result.response;
                let botReply = response.text();

                // Thêm thông tin hướng dẫn nếu là câu hỏi ôn thi
                if (examKeywords.some(keyword => userMessage.toLowerCase().includes(keyword.toLowerCase()))) {
                    botReply += "\n\nBạn có thể tham khảo thêm các đề thi thử trên website của trường hoặc liên hệ với giáo viên bộ môn để được hướng dẫn chi tiết hơn.";
                }

                displayTypingMessage(botReply, () => {
                    if (!isStopped) {
                        currentChat.messages.push({ 
                            role: "assistant", 
                            content: botReply,
                            timestamp: new Date().toISOString()
                        });
                        saveChats();
                    }
                }, new Date().toISOString());
            } catch (error) {
                console.error("Lỗi:", error);
                addMessageToUI("assistant", 
                    "Xin lỗi, đã có lỗi xảy ra khi tôi xử lý yêu cầu của bạn. Vui lòng thử lại sau.\n" +
                    "Nếu cần hỗ trợ gấp, bạn có thể liên hệ trực tiếp với Đoàn trường.", 
                    new Date().toISOString());
            } finally {
                isSending = false;
                typingIndicator.classList.add("hidden");
                stopButtonContainer.classList.add("hidden"); 
                scrollToBottom();
            }
        }

        function displayTypingMessage(content, callback, timestamp) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'message-wrapper bot';
            messageWrapper.innerHTML = `
                <div class="avatar bot">AI</div>
                <div class="bot-message flex-1">
                    <div class="message-content"></div>
                    <div class="message-timestamp">${new Date(timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
            `;
            chatMessages.appendChild(messageWrapper);
            scrollToBottom();

            let i = 0;
            const speed = 10;
            const contentDiv = messageWrapper.querySelector('.message-content');

            if (typingInterval) clearInterval(typingInterval);
            
            typingIndicator.classList.add("hidden"); 
            stopButtonContainer.classList.remove("hidden");
            typingInterval = setInterval(() => {
                if (isStopped) {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    contentDiv.innerHTML = formatMessage(content.substring(0, i));
                    stopButtonContainer.classList.add("hidden");
                    if (callback) callback();
                    if (window.MathJax) {
                        window.MathJax.typesetPromise([contentDiv]).catch((err) => console.error('MathJax render error:', err));
                    }
                    return;
                }

                if (i < content.length) {
                    contentDiv.innerHTML = formatMessage(content.substring(0, i + 1));
                    i++;
                    scrollToBottom();
                } else {
                    clearInterval(typingInterval);
                    typingInterval = null;
                    stopButtonContainer.classList.add("hidden");
                    if (callback) callback();
                }
                if (window.MathJax) {
                    window.MathJax.typesetPromise([contentDiv]).catch((err) => console.error('MathJax render error:', err));
                }
            }, speed);
        }

        function addMessageToUI(role, content, timestamp) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper ${role}`;
            
            const formattedContent = formatMessage(content);
            const timeString = new Date(timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            if (role === 'user') {
                messageWrapper.innerHTML = `
                    <div class="user-message flex-1">
                        <div class="message-content">${formattedContent}</div>
                        <div class="message-timestamp">${timeString}</div>
                    </div>
                    <div class="avatar user">Bạn</div>
                `;
            } else {
                messageWrapper.innerHTML = `
                    <div class="avatar bot">AI</div>
                    <div class="bot-message flex-1">
                        <div class="message-content">${formattedContent}</div>
                        <div class="message-timestamp">${timeString}</div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageWrapper);
            scrollToBottom();

            if (window.MathJax) {
                window.MathJax.typesetPromise([messageWrapper]).catch((err) => console.error('MathJax render error:', err));
            }
        }

        function formatMessage(content) {
            if (!content) return '';

            let formatted = escapeHtml(content);

            // Code blocks
            formatted = formatted.replace(/```([\w]*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const langDisplay = lang ? lang : 'text';
                return `<div class="code-block">
                    <div class="code-header flex justify-between items-center px-3 py-2 bg-gray-200 text-gray-600 text-xs rounded-t-md">
                        <span>${langDisplay}</span>
                        <button class="copy-code-btn hover:text-primary" onclick="copyToClipboard(this)" data-code="${encodeURIComponent(code.trim())}">
                            <i class="fas fa-copy"></i> Copy code
                        </button>
                    </div>
                    <pre><code class="language-${lang || 'text'}">${code.trim()}</code></pre>
                </div>`;
            });

            // Tables
            formatted = formatted.replace(/\|(.+)\|\n\|(?:[-:]+\|)+\n((?:\|.+\|\n)+)/g, (match) => {
                const [headerLine, separatorLine, ...dataLines] = match.split('\n').filter(Boolean);
                const headerCells = headerLine.split('|').slice(1, -1).map(cell => `<th>${cell.trim()}</th>`).join('');
                const tableRows = dataLines.map(row => {
                    const cells = row.split('|').slice(1, -1).map(cell => `<td>${cell.trim()}</td>`).join('');
                    return `<tr>${cells}</tr>`;
                }).join('');

                return `<div class="overflow-x-auto"><table class="w-full">
                    <thead><tr>${headerCells}</tr></thead>
                    <tbody>${tableRows}</tbody>
                </table></div>`;
            });

            // Bold, Italic, Inline Code
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.+?)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-1 py-0.5 rounded">$1</code>');

            // Blockquotes
            formatted = formatted.replace(/^&gt; (.+)$/gm, '<blockquote><p>$1</p></blockquote>');

            // Headings
            formatted = formatted.replace(/^###### (.+)$/gm, '<h6>$1</h6>');
            formatted = formatted.replace(/^##### (.+)$/gm, '<h5>$1</h5>');
            formatted = formatted.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^# (.+)$/gm, '<h1>$1</h1>');

            // Lists
            formatted = formatted.replace(/^\s*\*\s(.+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/^\s*(\d+)\.\s(.+)$/gm, '<li>$2</li>');
            formatted = formatted.replace(/(<li>.+<\/li>(\n<li>.+<\/li>)*)/g, (match) => {
                if (match.includes('1. ')) {
                    return `<ol>${match}</ol>`;
                }
                return `<ul>${match}</ul>`;
            });

            // Paragraphs and line breaks
            formatted = formatted.split('\n\n').map(paragraph => {
                if (paragraph.trim().startsWith('<') || paragraph.trim().startsWith('<li>') || paragraph.trim().startsWith('<blockquote>')) {
                    return paragraph;
                }
                return `<p>${paragraph.trim()}</p>`;
            }).join('');

            formatted = formatted.replace(/([^\n])\n([^\n])/g, '$1<br>$2');

            return formatted;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: 'Cuộc trò chuyện mới',
                messages: [],
                createdAt: new Date().toISOString()
            };

            chats.unshift(newChat);
            saveChats();
            renderChatHistory();
            loadChat(newChat.id);
            
            messageInput.focus();
        }

        function loadChat(chatId) {
            currentChatId = chatId;

            document.querySelectorAll('.chat-item').forEach(item => {
                if (item.dataset.id === chatId) {
                    item.classList.add('bg-light-hover');
                } else {
                    item.classList.remove('bg-light-hover');
                }
            });

            chatMessages.innerHTML = '';

            const currentChat = chats.find(chat => chat.id === chatId);
            if (!currentChat || currentChat.messages.length === 0) {
                 chatMessages.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <h3 class="text-xl font-semibold mb-2">Chào mừng bạn đến với Chatbot Đoàn trường</h3>
                        <p class="mb-4">Tôi có thể giúp bạn:</p>
                        <ul class="text-left max-w-md mx-auto list-disc pl-5">
                            <li class="mb-2">Ôn thi vào lớp 10 các môn Toán, Văn, Anh</li>
                            <li class="mb-2">Tìm hiểu về Đoàn Thanh niên Cộng sản Hồ Chí Minh</li>
                            <li class="mb-2">Cung cấp thông tin về trường THPT Chuyên Lê Quý Đôn</li>
                        </ul>
                    </div>`;
                return;
            }

            currentChat.messages.forEach(message => {
                addMessageToUI(message.role, message.content, message.timestamp);
            });
            
            scrollToBottom();
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();
            chats = chats.filter(chat => chat.id !== chatId);
            saveChats();
            renderChatHistory();

            if (chatId === currentChatId) {
                if (chats.length > 0) {
                    loadChat(chats[0].id);
                } else {
                    createNewChat();
                }
            }
        }

        function updateChatTitle(chat) {
            if (!chat || !chat.messages || chat.messages.length === 0) {
                chat.title = "Cuộc trò chuyện mới";
                saveChats();
                renderChatHistory();
                return;
            }

            const firstUserMessage = chat.messages.find(msg => msg.role === "user");
            if (firstUserMessage) {
                let title = firstUserMessage.content.substring(0, 40);
                if (firstUserMessage.content.length > 40) {
                    title += "...";
                }
                chat.title = title || "Cuộc trò chuyện mới";
            } else {
                chat.title = "Cuộc trò chuyện mới";
            }

            saveChats();
            renderChatHistory();
        }

        function renderChatHistory() {
            chatHistory.innerHTML = '';

            if (chats.length === 0) {
                chatHistory.innerHTML = `
                    <div class="text-center p-4 text-gray-400 text-sm">
                        Chưa có cuộc trò chuyện nào. <br>Nhấn <i class="fa-solid fa-plus"></i> để bắt đầu!
                    </div>
                `;
                return;
            }

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item p-3 rounded-md flex items-center justify-between cursor-pointer hover:bg-light-hover transition-colors ${chat.id === currentChatId ? 'bg-light-hover' : ''}`;
                chatItem.dataset.id = chat.id;

                const chatDate = new Date(chat.createdAt || parseInt(chat.id));
                const formattedDate = chatDate.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                chatItem.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                        <i class="fa-regular fa-message text-gray-500 text-sm flex-shrink-0"></i>
                        <div class="min-w-0">
                            <div class="chat-title truncate font-medium">${chat.title || 'Cuộc trò chuyện mới'}</div>
                            <div class="text-xs text-gray-500 truncate">${formattedDate}</div>
                        </div>
                    </div>
                    <button class="delete-chat-btn text-gray-500 hover:text-red-500 p-1 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;

                chatItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-chat-btn')) {
                        loadChat(chat.id);
                    }
                });

                const deleteBtn = chatItem.querySelector('.delete-chat-btn');
                deleteBtn.addEventListener('click', (e) => {
                    deleteChat(chat.id, e);
                });

                chatHistory.appendChild(chatItem);
            });
        }

        function loadChats() {
            const storedChats = localStorage.getItem('le-quy-don-chats');
            if (storedChats) {
                const now = Date.now();
                const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

                chats = JSON.parse(storedChats)
                    .filter(chat => now - new Date(chat.createdAt || parseInt(chat.id)).getTime() < THIRTY_DAYS)
                    .sort((a, b) => new Date(b.createdAt || parseInt(b.id)) - new Date(a.createdAt || parseInt(a.id)));
                    
                saveChats();
                renderChatHistory();
            }
        }

        function saveChats() {
            const now = Date.now();
            const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

            chats = chats.filter(chat => {
                const chatTime = new Date(chat.createdAt || parseInt(chat.id)).getTime();
                return now - chatTime < THIRTY_DAYS;
            });

            localStorage.setItem('le-quy-don-chats', JSON.stringify(chats));
        }

        function copyToClipboard(button) {
            const code = decodeURIComponent(button.getAttribute('data-code'));
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Đã sao chép!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Không thể sao chép văn bản.');
            });
        }

        window.addEventListener("beforeunload", () => {
            chats = chats.filter(chat => chat.messages.length > 0);
            saveChats();
        });

        document.addEventListener('DOMContentLoaded', initApp);
        
        window.copyToClipboard = copyToClipboard;
    </script>
</body>
</html>
