<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lê Quý Đôn Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#1a73e8',
                        secondary: '#ffffff',
                        light: {
                            bg: '#f0f2ff',
                            text: '#2c3e50',
                            sidebar: '#ffffff',
                            hover: '#e0e6ff'
                        }
                    },
                    fontFamily: {
                        sans: ['Calibri', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Calibri', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif';
            background-color: #f0f2ff;
            color: #2c3e50;
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #1a73e8 #e0e6ff;
        }

        #chat-container::-webkit-scrollbar {
            width: 8px;
        }

        #chat-container::-webkit-scrollbar-track {
            background: #e0e6ff;
            border-radius: 4px;
        }

        #chat-container::-webkit-scrollbar-thumb {
            background: #1a73e8;
            border-radius: 4px;
        }

        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #1557b0;
        }

        #chat-messages {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            max-width: 3xl;
            margin: 0 auto;
            width: 100%;
        }

        #typing-indicator, #stop-button-container {
            margin-top: 0;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
        }

        #chat-form {
            margin-top: 0;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }

        .code-block {
            position: relative;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #e9ecef;
        }

        .code-header {
            font-family: monospace;
            user-select: none;
        }

        .copy-code-btn {
            transition: all 0.2s;
            cursor: pointer;
        }

        .copy-code-btn:hover {
            color: #1a73e8;
        }

        pre {
            margin: 0 !important;
            padding: 1rem !important;
            background-color: #e9ecef !important;
            border-radius: 0 0 0.75rem 0.75rem;
            color: #2c3e50;
        }

        .markdown p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        .markdown ul, .markdown ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .markdown li {
            margin-bottom: 0.5rem;
        }

        .markdown code:not(pre code) {
            background-color: #dfe3e7;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: monospace;
            color: #2c3e50;
        }

        .markdown strong {
            font-weight: 700;
        }

        .markdown em {
            font-style: italic;
        }

        .markdown h1, .markdown h2, .markdown h3, .markdown h4 {
            font-weight: 700;
            margin-top: 1.8rem;
            margin-bottom: 1rem;
        }

        .markdown h1 {
            font-size: 1.75rem;
            line-height: 2.25rem;
        }

        .markdown h2 {
            font-size: 1.5rem;
            line-height: 2rem;
        }

        .markdown h3 {
            font-size: 1.25rem;
            line-height: 1.85rem;
        }

        .markdown h4 {
            font-size: 1.125rem;
            line-height: 1.65rem;
        }

        .markdown table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .markdown th, .markdown td {
            padding: 0.75rem 1rem;
            border: 1px solid #d0d0d0;
            text-align: left;
        }

        .markdown th {
            background-color: #e9ecef;
            font-weight: 700;
        }

        .markdown blockquote {
            border-left: 5px solid #1a73e8;
            padding-left: 1.2rem;
            margin: 1.5rem 0;
            color: #555555;
            border-radius: 0.75rem;
            background-color: rgba(26, 115, 232, 0.08);
        }

        .user-message {
            align-self: flex-end;
            background-color: #1a73e8;
            color: #ffffff;
            border-radius: 1.25rem 1.25rem 0.5rem 1.25rem;
            max-width: 80%;
            margin-left: auto;
            padding: 0.85rem 1.1rem;
        }

        .bot-message {
            align-self: flex-start;
            background-color: #ffffff;
            color: #2c3e50;
            border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
            max-width: 80%;
            margin-right: auto;
            padding: 0.85rem 1.1rem;
            border: 1px solid #e0e0e0;
        }

        .typing-indicator {
            align-self: flex-start;
            background-color: #ffffff;
            color: #2c3e50;
            border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
            max-width: 80%;
            margin-right: auto;
            padding: 0.85rem 1.1rem;
            border: 1px solid #e0e0e0;
        }

        .message-content {
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .message-wrapper.user {
            justify-content: flex-end;
        }

        .message-wrapper.bot {
            justify-content: flex-start;
        }

        .avatar {
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .avatar.user {
            background-color: #1a73e8;
            color: #ffffff;
        }

        .avatar.bot {
            background-color: #dee2e6;
            color: #495057;
        }

        .message-timestamp {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .user .message-timestamp {
            text-align: right;
            color: rgba(255, 255, 255, 0.8);
        }

        .bot .message-timestamp {
            text-align: left;
        }

        .chat-item.bg-light-hover {
            background-color: #e0e6ff;
            color: #1a73e8;
        }
        .chat-item.bg-light-hover .chat-title {
            color: #1a73e8;
        }
        .chat-item.bg-light-hover .text-xs {
            color: #6a8cdb;
        }

        header {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }

        @media (max-width: 767px) {
            #sidebar {
                position: absolute;
                z-index: 50;
                width: 75%;
                max-width: 240px;
                transform: translateX(-100%);
            }

            #sidebar.open {
                transform: translateX(0);
            }

            #app > div:last-child {
                width: 100%;
            }
        }

        @media (min-width: 768px) {
            #sidebar {
                transform: none !important;
            }
        }

        #sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }

        #sidebar-backdrop.visible {
            display: block;
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-light-bg text-light-text transition-all">
<div id="app" class="flex flex-1 overflow-hidden">
    <div id="sidebar" class="w-60 bg-light-sidebar shadow-lg border-r border-gray-200 flex flex-col h-full md:block hidden transition-all duration-300">
        <div class="p-3">
            <button id="new-chat-btn" class="w-full h-10 flex items-center justify-center bg-primary hover:bg-primary/90 text-white rounded-md transition px-4 py-2 text-sm font-medium">
                <i class="fa-solid fa-plus mr-2"></i> Cuộc trò chuyện mới
            </button>
        </div>
        <div id="chat-history" class="flex-1 overflow-y-auto hide-scrollbar p-2"></div>
    </div>

    <div class="flex-1 flex flex-col h-full overflow-hidden">
        <header class="p-4 border-b border-gray-200 bg-light-bg flex items-center justify-between">
            <button id="toggle-sidebar-btn" class="md:hidden text-gray-600 hover:text-primary focus:outline-none mr-3">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-xl font-semibold text-left flex-1">Chatbot Đoàn trường THPT Chuyên Lê Quý Đôn</h1>
            <a href="/suctrethanhnien/home" class="bg-primary hover:bg-primary/90 text-white rounded-md transition px-4 py-2 text-sm font-medium flex items-center">
                <i class="fa-solid fa-home mr-2"></i> Quay về trang chủ
            </a>
        </header>

        <div id="chat-container" class="flex-1 bg-gray-100">
            <div id="chat-messages" class="mx-auto max-w-3xl w-full"></div>
            <div id="typing-indicator" class="hidden max-w-3xl mx-auto text-center">
                <span class="typing-dots text-gray-600">AI đang suy nghĩ, vui lòng đợi giây lát</span>
            </div>
            <div id="stop-button-container" class="hidden max-w-3xl mx-auto text-center">
                <button id="stop-response-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="fa-solid fa-stop mr-2"></i> Dừng phản hồi
                </button>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-light-bg">
            <div class="max-w-3xl mx-auto">
                <form id="chat-form" class="relative">
                    <textarea 
                        id="message-input" 
                        class="w-full p-4 pr-12 rounded-lg border border-gray-300 bg-white resize-none focus:outline-none focus:ring-2 focus:ring-primary text-gray-800"
                        placeholder="Gửi tin nhắn..."
                        rows="1"
                    ></textarea>
                    <button type="submit" class="absolute right-3 bottom-3 p-2 bg-primary text-white rounded-full hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<div id="sidebar-backdrop"></div>

<script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
</script>
<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // Thay thế bằng API key thực tế của bạn
    const API_KEY = "AIzaSyAn9dMMM5u8dEGpI8mEzQvdMSuI8KFH8jM";
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

    const chatContainer = document.getElementById('chat-container');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const newChatBtn = document.getElementById('new-chat-btn');
    const chatHistory = document.getElementById('chat-history');
    const typingIndicator = document.getElementById('typing-indicator');
    const stopButtonContainer = document.getElementById('stop-button-container');
    const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebar-backdrop');

    let chats = [];
    let currentChatId = null;
    let isSending = false;
    let typingInterval = null;
    let isStopped = false;
    let schoolInfo = '';

    // Hàm tải nội dung từ file tailieu.txt
    async function fetchSchoolInfo() {
        try {
            const response = await fetch('https://hmtuan002.github.io/suctrethanhnien/tailieu.txt');
            if (!response.ok) {
                throw new Error('Không thể tải file tailieu.txt');
            }
            schoolInfo = await response.text();
            console.log('Loaded school info:', schoolInfo);
        } catch (error) {
            console.error('Error fetching tailieu.txt:', error);
            schoolInfo = 'Không thể tải thông tin trường. Vui lòng liên hệ Đoàn trường để biết thêm chi tiết.';
        }
    }

    // Hàm tìm kiếm thông tin chính xác trong schoolInfo
    function searchSchoolInfo(query) {
        if (!schoolInfo || schoolInfo.includes('Không thể tải thông tin')) {
            return null;
        }

        // Tách schoolInfo thành các đoạn (dựa trên dòng trống hoặc tiêu đề)
        const sections = schoolInfo.split('\n\n').filter(s => s.trim());
        const keywords = query.toLowerCase().split(/\s+/).filter(k => k.length > 2); // Loại bỏ từ ngắn
        const stopWords = ['là', 'có', 'và', 'của', 'ở', 'cho', 'tại', 'được', 'thì', 'một', 'những', 'rằng'];

        // Lọc từ khóa, loại bỏ stop words
        const filteredKeywords = keywords.filter(k => !stopWords.includes(k));

        if (filteredKeywords.length === 0) {
            return null;
        }

        // Tính điểm cho mỗi đoạn dựa trên số từ khóa khớp và độ tương đồng
        let bestMatch = null;
        let highestScore = 0;

        for (const section of sections) {
            const sectionLower = section.toLowerCase();
            let score = 0;

            // Đếm số từ khóa khớp
            for (const keyword of filteredKeywords) {
                if (sectionLower.includes(keyword)) {
                    score += 10; // Mỗi từ khóa khớp +10 điểm
                }
            }

            // Tăng điểm nếu đoạn chứa từ khóa chính như "trường", "đoàn"
            if (/trường|đoàn|lê quý đôn|hoạt động/i.test(sectionLower)) {
                score += 5;
            }

            // Giảm điểm nếu đoạn quá dài và không tập trung (tránh trả lời lan man)
            const sectionLength = section.split(' ').length;
            if (sectionLength > 100) {
                score -= Math.floor(sectionLength / 50); // Giảm điểm nếu quá dài
            }

            // Chỉ chọn đoạn nếu đạt ngưỡng tối thiểu
            if (score > highestScore && score >= 10) {
                highestScore = score;
                bestMatch = section;
            }
        }

        // Nếu không tìm thấy đoạn phù hợp, trả về null
        return bestMatch;
    }

    async function initApp() {
        console.log("Initializing app");
        await fetchSchoolInfo(); // Tải thông tin từ tailieu.txt
        loadChats();
        setupEventListeners();
        setupTextareaAutoResize();

        console.log("Chats after load:", chats);
        if (chats.length === 0) {
            console.log("No chats found, creating new chat");
            createNewChat();
        } else {
            console.log("Loading existing chat:", chats[0].id);
            loadChat(chats[0].id);
        }
    }

    function setupEventListeners() {
        chatForm.addEventListener('submit', handleSubmit);
        messageInput.addEventListener('input', () => {
            autoResizeTextarea();
        });
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (messageInput.value.trim() !== '') {
                    chatForm.dispatchEvent(new Event('submit'));
                }
            }
        });
        newChatBtn.addEventListener('click', createNewChat);

        document.getElementById('stop-response-btn').addEventListener('click', () => {
            isStopped = true;
            if (typingInterval) {
                clearInterval(typingInterval);
                typingInterval = null;
            }
            stopButtonContainer.classList.add('hidden');
            typingIndicator.classList.add("hidden");
        });

        toggleSidebarBtn.addEventListener('click', toggleSidebar);
        sidebarBackdrop.addEventListener('click', closeSidebar);
    }

    function toggleSidebar() {
        sidebar.classList.toggle('open');
        sidebarBackdrop.classList.toggle('visible');
    }

    function closeSidebar() {
        sidebar.classList.remove('open');
        sidebarBackdrop.classList.remove('visible');
    }

    function setupTextareaAutoResize() {
        messageInput.addEventListener('input', autoResizeTextarea);
    }

    function autoResizeTextarea() {
        messageInput.style.height = 'auto';
        const newHeight = Math.min(messageInput.scrollHeight, 150);
        messageInput.style.height = `${newHeight}px`;
    }

    async function handleSubmit(e) {
        e.preventDefault();
        const userMessage = messageInput.value.trim();
        if (!userMessage || isSending) return;

        if (!currentChatId) {
            createNewChat();
        }

        const currentChat = chats.find(chat => chat.id === currentChatId);
        if (!currentChat) {
            console.error("Không tìm thấy cuộc trò chuyện hiện tại!");
            return;
        }

        isSending = true;
        addMessageToUI("user", userMessage, new Date().toISOString());
        currentChat.messages.push({
            role: "user",
            content: userMessage,
            timestamp: new Date().toISOString()
        });
        saveChats();
        updateChatTitle(currentChat);

        messageInput.value = "";
        autoResizeTextarea();
        typingIndicator.classList.remove("hidden");
        stopButtonContainer.classList.remove("hidden");
        isStopped = false;

        try {
            const historyForGemini = currentChat.messages.map(msg => ({
                role: msg.role === "user" ? "user" : "model",
                parts: [{ text: msg.content }]
            })).slice(0, -1);

            // Kiểm tra xem câu hỏi có liên quan đến trường hoặc Đoàn trường không
            const isSchoolRelated = /trường|THPT Chuyên Lê Quý Đôn|Đoàn trường|Đoàn Thanh niên|hoạt động Đoàn/i.test(userMessage);

            let botReply;

            if (isSchoolRelated) {
                // Tìm kiếm trong schoolInfo trước
                const localAnswer = searchSchoolInfo(userMessage);
                if (localAnswer) {
                    botReply = `Dựa trên thông tin từ tài liệu của trường:\n\n${localAnswer}\n\nNếu bạn cần thêm chi tiết, vui lòng hỏi tiếp hoặc liên hệ trực tiếp với Đoàn trường.`;
                } else {
                    // Nếu không tìm thấy trong schoolInfo, sử dụng Gemini
                    const systemPrompt = `Bạn là Chatbot Đoàn trường THPT Chuyên Lê Quý Đôn tỉnh Điện Biên. Dưới đây là thông tin chi tiết về trường và Đoàn trường:\n\n${schoolInfo}\n\nDựa trên thông tin này, hãy trả lời câu hỏi một cách chính xác, ngắn gọn, chỉ cung cấp thông tin liên quan trực tiếp đến câu hỏi. Nếu không có thông tin phù hợp trong dữ liệu hoặc bạn không biết câu trả lời, hãy đề nghị người hỏi liên hệ trực tiếp với Đoàn trường.`;

                    const chatSession = model.startChat({
                        history: [
                            {
                                role: "user",
                                parts: [{ text: systemPrompt }]
                            },
                            {
                                role: "model",
                                parts: [{ text: "Tôi hiểu và sẽ trả lời chính xác dựa trên thông tin cung cấp." }]
                            },
                            ...historyForGemini
                        ],
                        generationConfig: {
                            maxOutputTokens: 2000,
                            temperature: 0.7,
                            topP: 0.9,
                            topK: 40,
                        }
                    });

                    const result = await chatSession.sendMessage(userMessage);
                    botReply = await result.response.text();

                    // Nếu Gemini không trả lời được chính xác
                    if (botReply.includes("Không có thông tin") || botReply.includes("Tôi không biết")) {
                        botReply += "\n\nDựa trên thông tin có sẵn, tôi không tìm thấy câu trả lời chính xác. Vui lòng liên hệ trực tiếp với Đoàn trường để biết thêm chi tiết.";
                    }
                }
            } else {
                // Câu hỏi không liên quan đến trường/Đoàn trường, sử dụng Gemini
                const systemPrompt = `Bạn là Chatbot Đoàn trường THPT Chuyên Lê Quý Đôn tỉnh Điện Biên. Nếu câu hỏi là về Đoàn Thanh niên Cộng sản Hồ Chí Minh, các hoạt động Đoàn và thông tin về trường, hãy trả lời một cách chính xác, ngắn gọn dựa trên thông tin sau:\n\n${schoolInfo}\n\nNếu không chắc chắn, hãy đề nghị người hỏi liên hệ trực tiếp với Đoàn trường. Nếu câu hỏi là về các môn toán, văn, anh để hỗ trợ ôn thi vào lớp 10, hãy trả lời câu hỏi một cách chi tiết, chính xác và dễ hiểu. Về giải bài tập, hãy trình bày từng bước rõ ràng. Còn câu hỏi lý thuyết, hãy giải thích ngắn gọn nhưng đầy đủ.`;

                const chatSession = model.startChat({
                    history: [
                        {
                            role: "user",
                            parts: [{ text: systemPrompt }]
                        },
                        {
                            role: "model",
                            parts: [{ text: "Tôi hiểu và sẽ trả lời chính xác dựa trên thông tin cung cấp." }]
                        },
                        ...historyForGemini
                    ],
                    generationConfig: {
                        maxOutputTokens: 2000,
                        temperature: 0.7,
                        topP: 0.9,
                        topK: 40,
                    }
                });

                const result = await chatSession.sendMessage(userMessage);
                botReply = await result.response.text();
            }

            displayTypingMessage(botReply, () => {
                if (!isStopped) {
                    currentChat.messages.push({
                        role: "assistant",
                        content: botReply,
                        timestamp: new Date().toISOString()
                    });
                    saveChats();
                }
            }, new Date().toISOString());

        } catch (error) {
            console.error("Lỗi:", error);
            addMessageToUI("assistant",
                "Xin lỗi, đã có lỗi xảy ra khi tôi xử lý yêu cầu của bạn. Vui lòng thử lại sau.\n" +
                "Nếu cần hỗ trợ gấp, bạn có thể liên hệ trực tiếp với Đoàn trường.",
                new Date().toISOString());
            if (currentChat) {
                currentChat.messages.push({
                    role: "assistant",
                    content: "Xin lỗi, đã có lỗi xảy ra khi tôi xử lý yêu cầu của bạn. Vui lòng thử lại sau.\n" +
                             "Nếu cần hỗ trợ gấp, bạn có thể liên hệ trực tiếp với Đoàn trường.",
                    timestamp: new Date().toISOString()
                });
                saveChats();
            }
        } finally {
            isSending = false;
            typingIndicator.classList.add("hidden");
            stopButtonContainer.classList.add("hidden");
            scrollToBottom();
        }
    }

    function displayTypingMessage(content, callback, timestamp) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = 'message-wrapper bot';
        messageWrapper.innerHTML = `
            <div class="avatar bot">AI</div>
            <div class="bot-message flex-1">
                <div class="message-content"></div>
                <div class="message-timestamp">${new Date(timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}</div>
            </div>
        `;
        chatMessages.appendChild(messageWrapper);
        scrollToBottom();

        let i = 0;
        const speed = 10;
        const contentDiv = messageWrapper.querySelector('.message-content');

        if (typingInterval) clearInterval(typingInterval);

        typingIndicator.classList.add("hidden");
        stopButtonContainer.classList.remove("hidden");
        typingInterval = setInterval(() => {
            if (isStopped) {
                clearInterval(typingInterval);
                typingInterval = null;
                contentDiv.innerHTML = formatMessage(content.substring(0, i));
                stopButtonContainer.classList.add("hidden");
                if (callback) callback();
                if (window.MathJax) {
                    window.MathJax.typesetPromise([contentDiv]).catch((err) => console.error('MathJax render error:', err));
                }
                return;
            }

            if (i < content.length) {
                contentDiv.innerHTML = formatMessage(content.substring(0, i + 1));
                i++;
                scrollToBottom();
            } else {
                clearInterval(typingInterval);
                typingInterval = null;
                stopButtonContainer.classList.add("hidden");
                if (callback) callback();
            }
            if (window.MathJax) {
                window.MathJax.typesetPromise([contentDiv]).catch((err) => console.error('MathJax render error:', err));
            }
        }, speed);
    }

    function addMessageToUI(role, content, timestamp) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `message-wrapper ${role}`;

        const formattedContent = formatMessage(content);
        const timeString = new Date(timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

        if (role === 'user') {
            messageWrapper.innerHTML = `
                <div class="user-message flex-1">
                    <div class="message-content">${formattedContent}</div>
                    <div class="message-timestamp">${timeString}</div>
                </div>
                <div class="avatar user">Bạn</div>
            `;
        } else {
            messageWrapper.innerHTML = `
                <div class="avatar bot">AI</div>
                <div class="bot-message flex-1">
                    <div class="message-content">${formattedContent}</div>
                    <div class="message-timestamp">${timeString}</div>
                </div>
            `;
        }

        chatMessages.appendChild(messageWrapper);
        scrollToBottom();

        if (window.MathJax) {
            window.MathJax.typesetPromise([messageWrapper]).catch((err) => console.error('MathJax render error:', err));
        }
    }

    function formatMessage(content) {
        if (!content) return '';

        let formatted = escapeHtml(content);

        formatted = formatted.replace(/```([\w]*)\n([\s\S]*?)```/g, (match, lang, code) => {
            const langDisplay = lang ? lang : 'text';
            const escapedCode = escapeHtml(code.trim());
            return `<div class="code-block">
                <div class="code-header flex justify-between items-center px-3 py-2 bg-gray-200 text-gray-600 text-xs rounded-t-md">
                    <span>${langDisplay}</span>
                    <button class="copy-code-btn hover:text-primary" onclick="copyToClipboard(this)" data-code="${encodeURIComponent(code.trim())}">
                        <i class="fas fa-copy"></i> Copy code
                    </button>
                </div>
                <pre><code class="language-${lang || 'text'}">${escapedCode}</code></pre>
            </div>`;
        });

        formatted = formatted.replace(/^\|(.+)\|\s*\n\|\s*(?:[:\-]+\|)+\s*\n((?:\|.+\|\s*\n)*)/gm, (match, headerLine, dataLines) => {
            const headers = headerLine.split('|').slice(1, -1).map(h => `<th>${h.trim()}</th>`).join('');
            const rows = dataLines.trim().split('\n').map(rowLine => {
                const cells = rowLine.split('|').slice(1, -1).map(c => `<td>${c.trim()}</td>`).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
            return `<div class="overflow-x-auto markdown"><table class="w-full"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table></div>`;
        });

        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
        formatted = formatted.replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-1 py-0.5 rounded text-sm">$1</code>');

        formatted = formatted.replace(/^>\s*(.+)$/gm, (match, content) => {
            return `<blockquote><p>${content.replace(/\n>\s*/g, '<br>')}</p></blockquote>`;
        });

        formatted = formatted.replace(/^###### (.+)$/gm, '<h6 class="markdown">$1</h6>');
        formatted = formatted.replace(/^##### (.+)$/gm, '<h5 class="markdown">$1</h5>');
        formatted = formatted.replace(/^#### (.+)$/gm, '<h4 class="markdown">$1</h4>');
        formatted = formatted.replace(/^### (.+)$/gm, '<h3 class="markdown">$1</h3>');
        formatted = formatted.replace(/^## (.+)$/gm, '<h2 class="markdown">$1</h2>');
        formatted = formatted.replace(/^# (.+)$/gm, '<h1 class="markdown">$1</h1>');

        formatted = formatted.replace(/^\s*[\-\*]\s(.+)$/gm, '<li>$1</li>');
        formatted = formatted.replace(/((<li>.+<\/li>\s*)+)/g, (match) => {
            if (!match.startsWith('<ul>') && !match.startsWith('<ol>')) {
                return `<ul class="markdown">${match.trim()}</ul>`;
            }
            return match;
        });

        formatted = formatted.replace(/^\s*(\d+)\.\s(.+)$/gm, '<li data-ordered="true">$2</li>');
        formatted = formatted.replace(/((<li data-ordered="true">.+<\/li>\s*)+)/g, (match) => {
            if (!match.startsWith('<ul>') && !match.startsWith('<ol>')) {
                const listItems = match.replace(/data-ordered="true"/g, '');
                return `<ol class="markdown">${listItems.trim()}</ol>`;
            }
            return match;
        });

        const blockElementsRegex = /^(?:<h[1-6]|<ul|<ol|<li|<blockquote|<pre|<div|<table)/;
        formatted = formatted.split('\n\n').map(paragraph => {
            const trimmedParagraph = paragraph.trim();
            if (!trimmedParagraph) return '';
            if (blockElementsRegex.test(trimmedParagraph) || trimmedParagraph.startsWith('<li>')) {
                return trimmedParagraph;
            }
            return `<p class="markdown">${trimmedParagraph.replace(/\n/g, '<br>')}</p>`;
        }).join('');

        formatted = formatted.replace(/<p class="markdown">\s*<br>\s*<\/p>/g, '');
        formatted = formatted.replace(/<br>\s*<\/p>/g, '</p>');
        formatted = formatted.replace(/<br>\s*<\/li>/g, '</li>');

        return `<div class="markdown">${formatted}</div>`;
    }

    function escapeHtml(text) {
        if (typeof text !== 'string') return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function scrollToBottom() {
        setTimeout(() => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 100);
    }

    function createNewChat() {
        console.log("createNewChat called");
        try {
            const newChat = {
                id: Date.now().toString(),
                title: 'Cuộc trò chuyện mới',
                messages: [],
                createdAt: new Date().toISOString()
            };

            chats.unshift(newChat);
            currentChatId = newChat.id;
            saveChats();
            renderChatHistory();
            loadChat(newChat.id);
            messageInput.focus();
        } catch (error) {
            console.error("Error in createNewChat:", error);
            alert("Không thể tạo cuộc trò chuyện mới. Vui lòng thử lại.");
        }
    }

    function loadChat(chatId) {
        console.log("Loading chat with ID:", chatId);
        try {
            currentChatId = chatId;

            document.querySelectorAll('.chat-item').forEach(item => {
                if (item.dataset.id === chatId) {
                    item.classList.add('bg-light-hover');
                } else {
                    item.classList.remove('bg-light-hover');
                }
            });

            chatMessages.innerHTML = '';

            const currentChat = chats.find(chat => chat.id === chatId);
            console.log("Current chat:", currentChat);
            if (!currentChat || currentChat.messages.length === 0) {
                chatMessages.innerHTML = `
                    <div class="text-center text-gray-500 mt-20">
                        <h3 class="text-xl font-semibold mb-2">Chào mừng bạn đến với Chatbot Đoàn trường</h3>
                        <p class="mb-4">Tôi có thể giúp bạn về nhiều chủ đề khác nhau. Hãy hỏi tôi bất cứ điều gì!</p>
                        <ul class="text-left max-w-md mx-auto list-disc pl-5">
                            <li class="mb-2">Đặt câu hỏi về Đoàn Thanh niên</li>
                            <li class="mb-2">Tìm hiểu thông tin trường THPT Chuyên Lê Quý Đôn</li>
                            <li class="mb-2">Hỗ trợ ôn thi vào lớp 10 (Toán, Văn, Anh)</li>
                            <li class="mb-2">Và nhiều hơn nữa...</li>
                        </ul>
                    </div>`;
                return;
            }

            currentChat.messages.forEach(message => {
                addMessageToUI(message.role, message.content, message.timestamp);
            });

            scrollToBottom();
        } catch (error) {
            console.error("Error in loadChat:", error);
            alert("Không thể tải cuộc trò chuyện. Vui lòng thử lại.");
        }
    }

    function deleteChat(chatId, event) {
        event.stopPropagation();
        try {
            chats = chats.filter(chat => chat.id !== chatId);
            saveChats();
            renderChatHistory();

            if (chatId === currentChatId) {
                if (chats.length > 0) {
                    loadChat(chats[0].id);
                } else {
                    createNewChat();
                }
            }
        } catch (error) {
            console.error("Error in deleteChat:", error);
            alert("Không thể xóa cuộc trò chuyện. Vui lòng thử lại.");
        }
    }

    function updateChatTitle(chat) {
        try {
            if (!chat || !chat.messages || chat.messages.length === 0) {
                chat.title = "Cuộc trò chuyện mới";
            } else {
                const firstUserMessage = chat.messages.find(msg => msg.role === "user");
                if (firstUserMessage && firstUserMessage.content) {
                    let title = firstUserMessage.content.substring(0, 40);
                    if (firstUserMessage.content.length > 40) {
                        title += "...";
                    }
                    chat.title = title || "Cuộc trò chuyện mới";
                } else {
                    chat.title = "Cuộc trò chuyện mới";
                }
            }
            const existingChatItem = document.querySelector(`.chat-item[data-id="${chat.id}"] .chat-title`);
            if (!existingChatItem || existingChatItem.textContent !== chat.title) {
                saveChats();
                renderChatHistory();
            }
        } catch (error) {
            console.error("Error in updateChatTitle:", error);
        }
    }

    function renderChatHistory() {
        console.log("Rendering chat history:", chats);
        try {
            chatHistory.innerHTML = '';

            if (chats.length === 0) {
                chatHistory.innerHTML = `
                    <div class="text-center p-4 text-gray-400 text-sm">
                        Chưa có cuộc trò chuyện nào. <br>Nhấn <i class="fa-solid fa-plus"></i> để bắt đầu!
                    </div>
                `;
                return;
            }

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item p-3 rounded-md flex items-center justify-between cursor-pointer hover:bg-light-hover transition-colors ${chat.id === currentChatId ? 'bg-light-hover' : ''}`;
                chatItem.dataset.id = chat.id;

                const chatDate = new Date(chat.createdAt || parseInt(chat.id));
                const formattedDate = chatDate.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                chatItem.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden flex-1 min-w-0">
                        <i class="fa-regular fa-message text-gray-500 text-sm flex-shrink-0"></i>
                        <div class="min-w-0">
                            <div class="chat-title truncate font-medium">${escapeHtml(chat.title) || 'Cuộc trò chuyện mới'}</div>
                            <div class="text-xs text-gray-500 truncate">${formattedDate}</div>
                        </div>
                    </div>
                    <button class="delete-chat-btn text-gray-500 hover:text-red-500 p-1 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                `;

                chatItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-chat-btn')) {
                        loadChat(chat.id);
                    }
                });

                const deleteBtn = chatItem.querySelector('.delete-chat-btn');
                deleteBtn.addEventListener('click', (e) => {
                    deleteChat(chat.id, e);
                });

                chatHistory.appendChild(chatItem);
            });
        } catch (error) {
            console.error("Error in renderChatHistory:", error);
            chatHistory.innerHTML = `
                <div class="text-center p-4 text-red-500 text-sm">
                    Lỗi khi hiển thị lịch sử trò chuyện. Vui lòng thử lại.
                </div>
            `;
        }
    }

    function loadChats() {
        try {
            const storedChats = localStorage.getItem('le-quy-don-chats');
            if (storedChats) {
                const now = Date.now();
                const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

                chats = JSON.parse(storedChats)
                    .filter(chat => chat.id && (now - new Date(chat.createdAt || parseInt(chat.id)).getTime() < THIRTY_DAYS))
                    .sort((a, b) => new Date(b.createdAt || parseInt(b.id)) - new Date(a.createdAt || parseInt(a.id)));

                console.log("Loaded chats:", chats);
                saveChats();
            } else {
                chats = [];
            }
            renderChatHistory();
        } catch (error) {
            console.error("Error in loadChats:", error);
            chats = [];
            localStorage.removeItem('le-quy-don-chats');
            renderChatHistory();
        }
    }

    function saveChats() {
        try {
            const now = Date.now();
            const THIRTY_DAYS = 30 * 24 * 60 * 60 * 1000;

            const recentChats = chats.filter(chat => {
                const chatTime = new Date(chat.createdAt || parseInt(chat.id)).getTime();
                return (now - chatTime) < THIRTY_DAYS;
            });
            const validChats = recentChats.filter(chat => {
                return chat.messages.length > 0 || chat.id === currentChatId;
            });

            console.log("Saving chats:", validChats);
            localStorage.setItem('le-quy-don-chats', JSON.stringify(validChats));
            chats = validChats;
        } catch (error) {
            console.error("Error in saveChats:", error);
        }
    }

    window.copyToClipboard = function(button) {
        try {
            const code = decodeURIComponent(button.getAttribute('data-code'));
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Đã sao chép!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                const textArea = document.createElement("textarea");
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i> Đã sao chép!';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                } catch (execErr) {
                    console.error('Fallback copy failed: ', execErr);
                    alert('Không thể sao chép văn bản.');
                }
                document.body.removeChild(textArea);
            });
        } catch (error) {
            console.error("Error in copyToClipboard:", error);
            alert("Không thể sao chép mã. Vui lòng thử lại.");
        }
    }

    window.addEventListener("beforeunload", () => {
        try {
            chats = chats.filter(chat => {
                return chat.messages.length > 0 || (chat.id === currentChatId && chat.messages.length === 0 && chats.length === 1);
            });
            saveChats();
        } catch (error) {
            console.error("Error in beforeunload:", error);
        }
    });

    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>